<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="A Chat-App">
    <meta name="author" content="Rohit Lalchandani">

    <title>CalHacks Checkers</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet"> <!-- Bootstrap -->
    <link href="css/chessboard.css" rel="stylesheet"> <!-- Chessboard -->
    <link rel="stylesheet" type="text/css" href="css/sweetalert.css"> <!-- SweetAlertJS -->

    <!-- Padding for navbar -->
    <style>
/*      body { 
        padding-top: 65px; 
      }*/
    </style>
  </head>

  <body>

    <!-- Checkers Table -->
    <table id="chess_board" cellpadding="0" cellspacing="0"></table>

    <p id='whosTurn' style='font-size: 30px'></p>
    <p id='whoYouAre' style='font-size: 30px'></p>

    <!-- Socket.io for messaging -->
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="js/sweetalert.min.js"></script>
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <!-- JQuery selectors -->
    <script src="js/logic.js"></script>
    <script>

        var board; // JS Object representing board
        var hasMoved = false; // If you have moved
        var player; // Which player you are
        var turn; // Who turn it is

        var selectedPiece; // JS Object of selected
        var src; // Coordinates of selected piece
        var hasSelectedPiece = false; // If a piece has been selected

        var socket = io(); // Create a new socket for this user

        // Recieving board from server
        socket.on('board', function(boardJSON) {
            board = JSON.parse(boardJSON);
            drawboard(board);
        });

        socket.on('player', function(playerType) {
            player = playerType;
            $("#whoYouAre").html("You are player " + player);
        });

        socket.on('startGame', function(firstTurn) {
            turn = firstTurn;
            $("#whosTurn").html("It is player " + turn + "'s turn.");
        })

        /* Making a selection or move */
        $('table').on("click", ".location",function() {

            var hasPiece = $(this).attr('hasPiece');
            var tempSrc = $(this).attr('id').split("-"); // [x, y]
            tempSrc = [parseInt(src[0]), parseInt(src[1])];
            var tempPiece = board[tempSrc[0]][tempSrc[1]]

            if (hasPiece === "true" && !hasMoved && tempPiece.team == player) { // Selecting a piece
                src = $(this).attr('id').split("-"); // [x, y]
                src = [parseInt(src[0]), parseInt(src[1])];
                var hasPiece = $(this).attr('hasPiece');
                var potentialPiece = board[src[0]][src[1]]; // we don't know if we can select this piece
                if (hasPiece === "true" && canSelect(potentialPiece)) {
                    selectedPiece = potentialPiece; // Get Piece from Board
                    hasSelectedPiece = true;
                }

            } else { // Executing a move
                var dest = $(this).attr('id').split("-");
                dest = [parseInt(dest[0]), parseInt(dest[1])];
                var move_status = canMove(selectedPiece, src, dest);
                if (move_status !== -1) { // we are at least moving
                    // Create New Board Object
                    if (move_status === 1) { //capture
                        board[(src[0] + dest[0])/2][(src[1] + dest[1])/2] = null;
                        board[dest[0]][dest[1]] = selectedPiece;
                        board[src[0]][src[1]] = null;
                        src = dest;
                    }
                    if (move_status === 0 && !hasMoved) {//move
                        board[dest[0]][dest[1]] = selectedPiece;
                        board[src[0]][src[1]] = null;
                        hasSelectedPiece = false; //turn has to be over
                        
                    }
                    hasMoved = true;
                    if (canKing(selectedPiece, dest)) {
                        selectedPiece.isKing = true;
                    }
                    drawboard(board);
                    socket.emit('refreshBoard', JSON.stringify(board));
                }
                
            }

        });

        $('body').keypress(function(e) {
            if (e.keyCode == 32 && hasMoved) {//can end turn
                endTurn();
                socket.emit('turnEnded', JSON.stringify(board));
                //switch whose turn it is
            }
        });

    </script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/js/bootstrap.min.js"></script>

  </body>
</html>