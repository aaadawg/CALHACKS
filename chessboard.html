<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Online Checkers">
    <meta name="author" content="Rohit Lalchandani, Pranay Kumar, Anish Balaji, Brennen Nelson">

    <title>CalHacks Checkers</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet"> <!-- Bootstrap -->
    <link href="css/chessboard.css" rel="stylesheet"> <!-- Chessboard -->
    <link rel="stylesheet" type="text/css" href="css/sweetalert.css"> <!-- SweetAlertJS -->

    <!-- Padding for navbar -->
    <style>
/*      body { 
        padding-top: 65px; 
      }*/
    </style>
  </head>

  <body>

    <!-- Checkers Table -->
    <table id="chess_board" cellpadding="0" cellspacing="0"></table>

    <!-- Messages Container -->
    <div class="container">
      <div class="jumbotron">

          <!-- Row 1 -->
          <div class="row">
            <div class="col-md-10">
              <h4>Message Feed</h4>
            </div>
            <div class="col-md-2">
              <button type="button" id="clearButton" class="btn btn-warning btn-sm">Clear Message History</button>
            </div>
          </div>

          <!-- Messages Table -->
          <table class="table table-striped">
            <thead>
              <tr>
                <th>User</th>
                <th>Message</th>
              </tr>
            </thead>
            <tbody id="messages"></tbody>
          </table>

      </div> <!--/jumbotron-->
    </div><!--/container -->

    <!-- Messages Input -->
    <div class="container">

      <!-- Message Form -->
      <div class="row">
        <div class="col-md-10">
            <input type="text" id="m" class="form-control" autofocus placeholder="Send a message">
        </div>
        <div class="col-md-2">
          <button type="submit" id="submitbtn" class="btn btn-primary">Send Message</button>
        </div>
      </div><!-- /row -->

      <br>

      <!-- Username Form -->
      <div class="row">
        <div class="col-md-10">
            <input type="text" id="username" class="form-control" placeholder="Enter username (default: anonymous)">
        </div>
        <div class="col-md-2">
          <span class="badge" id='usersOnline'></span>
        </div>
      </div><!-- /row -->
    </div>

    <p id='whosTurn' style='font-size: 30px'></p>
    <p id='whoYouAre' style='font-size: 30px'></p>
    <p id='yourPoints' style='font-size: 30px'></p>

    <!-- Socket.io for messaging -->
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="js/sweetalert.min.js"></script>
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <!-- JQuery selectors -->
    <script src="js/logic.js"></script>
    <script>

        var board; // JS Object representing board
        var hasMoved = false; // If you have moved
        var player; // Which player you are
        var turn; // Who turn it is
        var playerPoints;

        var selectedPiece; // JS Object of selected
        var src; // Coordinates of selected piece
        var hasSelectedPiece = false; // If a piece has been selected

        var socket = io(); // Create a new socket for this user

        // Recieving board from server
        socket.on('board', function(boardJSON) {
          board = JSON.parse(boardJSON);
          drawboard(board);
        });

        socket.on('player', function(playerType, points) {
            player = playerType;
            $("#whoYouAre").html("You are player " + player);
            $("#yourPoints").html("You have " + points + " points.");

        });

        socket.on('startGame', function(firstTurn, points) {
            turn = firstTurn;
            playerPoints = points;
            $("#whosTurn").html("It is player " + turn + "'s turn.");
        })

        var moveKey = 0;

        /******************
         * Messaging code *
         ******************/
        /* Sends the message in the message input box to the server */
        function sendMessage() {
          if ($('#username').val() == "") {
            var user = "anonymous";
          } else {
            var user = $('#username').val();
          }

          var messagePacket = {msg: $('#m').val(), username: user};
          socket.emit('chat message', JSON.stringify(messagePacket));
          $('#m').val('');
        }

        /* Socket listener for incoming message */
        socket.on('chat message', function(response) {
          var messagePacket = JSON.parse(response);
          $('#messages').append("<tr><th>" + messagePacket.username + "</th><td style='word-break:break-all;'>" + messagePacket.msg + "</td></tr>");
        });

        /* Event Listener for clear button */
        $('#clearButton').click(function (e) {
          $('#messages').fadeOut(400, function() {
            $('#messages').empty().fadeIn();
          });
        });

        /* Event Listener for submit button */
        $('#submitbtn').click(function(){
          if ($('#m').val().trim() != "") {
            sendMessage();
          }
        });

        /* Event Listener for enter key to submit message */
        $('#m').keypress(function (e) {
          if (e.which == 13) {
            if ($('#m').val().trim() != "") {
              sendMessage();
            }
          }
        });

        /* Making a selection or move */
        $('table').on("click", ".location",function() {

            var tempSrc = $(this).attr('id').split("-"); // [x, y]
            tempSrc = [parseInt(tempSrc[0]), parseInt(tempSrc[1])];
            var pieceAtSpot = getPiece(board, tempSrc);
            console.log(pieceAtSpot);

            if (canSelect(pieceAtSpot)) { // Selecting a piece
                src = tempSrc;
                selectedPiece = pieceAtSpot; // Get Piece from Board
                hasSelectedPiece = true;

            } else { // Executing a move
                var dest = tempSrc;
                var move_status = canMove(selectedPiece, src, dest);
                var moveBackwards = movedBackwards(selectedPiece, src, dest);
                console.log(selectedPiece);
                console.log(src);
                console.log(dest);
                console.log(movedBackwards(selectedPiece, src, dest));
                console.log(playerPoints);
                console.log(false);
                if (move_status !== -1) { // we are at least moving
                    // Create New Board Object
                    board[dest[0]][dest[1]] = selectedPiece;
                    board[src[0]][src[1]] = null;
                    if (move_status === 1) { //capture
                        board[(src[0] + dest[0])/2][(src[1] + dest[1])/2] = null;
                        src = dest;
                        if (selectedPiece.isKing) {
                            moveKey += 3;
                        } else {
                            moveKey += 2;
                        }
                    }
                    else if (move_status === 0) {//move
                        hasSelectedPiece = false; //turn has to be over
                        
                    }
                    if (canKing(selectedPiece, dest)) {
                        selectedPiece.isKing = true;
                    }
                    if (moveBackwards && !selectedPiece.isKing) {
                        moveKey -= 1;
                    }
                    hasMoved = true;
                    drawboard(board);
                    socket.emit('refreshBoard', JSON.stringify(board), moveKey);
                }
                
            }


            //Default points in bank for everybody is 2
            //Any non-king move backwards is -1
            //Any capture is 2
            //Any king capture is 3


        });

        $('body').keypress(function(e) {
            if (e.keyCode == 32 && hasMoved) {//can end turn
                endTurn();
                socket.emit('turnEnded', JSON.stringify(board));
                //switch whose turn it is
            }
        });

    </script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/js/bootstrap.min.js"></script>

  </body>
</html>